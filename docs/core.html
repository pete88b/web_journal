---

title: Core


keywords: fastai
sidebar: home_sidebar

summary: "Core tools for working with storage."
description: "Core tools for working with storage."
nb_path: "00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="read_config" class="doc_header"><code>read_config</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L17" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>read_config</code>(<strong><code>section_name</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>config_name</code></strong>:<code>str</code>=<em><code>'secrets/settings.ini'</code></em>)</p>
</blockquote>
<p>Read the INI file <code>config_name</code> and return a dict for <code>section_name</code> if specified</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If <code>section_name</code> is not specified, this function will return the <code>ConfigParser</code> used to read the INI file.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">read_config</span><span class="p">(),</span><span class="n">ConfigParser</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">read_config</span><span class="p">()[</span><span class="s1">&#39;DEFAULT&#39;</span><span class="p">],</span><span class="n">SectionProxy</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">read_config</span><span class="p">(</span><span class="s1">&#39;DEFAULT&#39;</span><span class="p">),</span><span class="nb">dict</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">read_config</span><span class="p">(</span><span class="s1">&#39;local_cwd&#39;</span><span class="p">,</span><span class="n">config_name</span><span class="o">=</span><span class="s1">&#39;test/settings.ini&#39;</span><span class="p">)[</span><span class="s1">&#39;storage_client&#39;</span><span class="p">],</span>
        <span class="s1">&#39;storage_tools.core.LocalStorageClient&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="parse_dataset_archive_name" class="doc_header"><code>parse_dataset_archive_name</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L29" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>parse_dataset_archive_name</code>(<strong><code>name</code></strong>:<code>str</code>)</p>
</blockquote>
<p>Returns (name,version) if <code>name</code> is a dataset archive name, <code>None</code> otherwise</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">((</span><span class="s1">&#39;dsetname&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.1&#39;</span><span class="p">),</span> <span class="n">parse_dataset_archive_name</span><span class="p">(</span><span class="s1">&#39;dsetname.0.0.1.zip&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">((</span><span class="s1">&#39;dsetname.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;0.2.1&#39;</span><span class="p">),</span> <span class="n">parse_dataset_archive_name</span><span class="p">(</span><span class="s1">&#39;dsetname.txt.0.2.1.zip&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">((</span><span class="s1">&#39;path/to/dsetname&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.1&#39;</span><span class="p">),</span> <span class="n">parse_dataset_archive_name</span><span class="p">(</span><span class="s1">&#39;path/to/dsetname.0.0.1.zip&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">((</span><span class="s1">&#39;//path/to/dsetname&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.1&#39;</span><span class="p">),</span> <span class="n">parse_dataset_archive_name</span><span class="p">(</span><span class="s1">&#39;//path/to/dsetname.0.0.1.zip&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">parse_dataset_archive_name</span><span class="p">(</span><span class="s1">&#39;dsetname.0.0.1.csv&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">parse_dataset_archive_name</span><span class="p">(</span><span class="s1">&#39;dsetname.0.1.zip&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">parse_dataset_archive_name</span><span class="p">(</span><span class="s1">&#39;dsetname.0.a.1.csv&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">parse_dataset_archive_name</span><span class="p">(</span><span class="s1">&#39;.0.0.1.zip&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">parse_dataset_archive_name</span><span class="p">(</span><span class="s1">&#39;0.0.1.csv&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">parse_dataset_archive_name</span><span class="p">(</span><span class="s1">&#39;dsetname.0.0.1&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="parse_dataset_archive_version" class="doc_header"><code>parse_dataset_archive_version</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L35" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>parse_dataset_archive_version</code>(<strong><code>version</code></strong>:<code>str</code>)</p>
</blockquote>
<p>Returns (major,minor,patch) if <code>version</code> is a valid dataset archive version</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">parse_dataset_archive_version</span><span class="p">(</span><span class="s1">&#39;0.1.2&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="n">parse_dataset_archive_version</span><span class="p">(</span><span class="s1">&#39;5.4.3&#39;</span><span class="p">))</span>
<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">parse_dataset_archive_version</span><span class="p">(</span><span class="s1">&#39;0.1.2.&#39;</span><span class="p">))</span>
<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">parse_dataset_archive_version</span><span class="p">(</span><span class="s1">&#39;0.1&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="next_version" class="doc_header"><code>next_version</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L42" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>next_version</code>(<strong><code>versions</code></strong>:<code>List</code>[<code>str</code>]=<em><code>None</code></em>, <strong><code>increment</code></strong>:<code>str</code>=<em><code>'patch'</code></em>)</p>
</blockquote>
<p>Return the version that should follow the last version in <code>versions</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="s1">&#39;0.0.1&#39;</span><span class="p">,</span><span class="n">next_version</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="s1">&#39;33.55.67&#39;</span><span class="p">,</span><span class="n">next_version</span><span class="p">([</span><span class="s1">&#39;2.4.60&#39;</span><span class="p">,</span><span class="s1">&#39;33.55.66&#39;</span><span class="p">]))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="s1">&#39;0.1.0&#39;</span><span class="p">,</span><span class="n">next_version</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;minor&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="s1">&#39;1.0.0&#39;</span><span class="p">,</span><span class="n">next_version</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;major&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="s1">&#39;3.0.0&#39;</span><span class="p">,</span><span class="n">next_version</span><span class="p">([</span><span class="s1">&#39;2.4.60&#39;</span><span class="p">],</span><span class="s1">&#39;major&#39;</span><span class="p">))</span>
<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">next_version</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;beta&#39;</span><span class="p">))</span>
<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">next_version</span><span class="p">([</span><span class="s1">&#39;2.4.60&#39;</span><span class="p">,</span><span class="s1">&#39;33.55.66a&#39;</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="sha256" class="doc_header"><code>sha256</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L52" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>sha256</code>(<strong><code>file</code></strong>:<code>Union</code>[<code>Path</code>, <code>str</code>])</p>
</blockquote>
<p>Return the secure hash (as a hex digest) of the specified file</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">sha256</span><span class="p">(</span><span class="s1">&#39;test/test_data.csv&#39;</span><span class="p">),</span><span class="n">sha256</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;test/test_data.csv&#39;</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_or_update_manifest" class="doc_header"><code>make_or_update_manifest</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L69" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_or_update_manifest</code>(<strong><code>archive_folder</code></strong>:<code>Union</code>[<code>Path</code>, <code>str</code>])</p>
</blockquote>
<p>Create or update a manifest in <code>archive_folder</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="check_archive" class="doc_header"><code>check_archive</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L81" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>check_archive</code>(<strong><code>archive_folder</code></strong>:<code>Union</code>[<code>Path</code>, <code>str</code>])</p>
</blockquote>
<p>Check that all files listed in manifest.json have the correct secure hash</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_dataset_archive_folder" class="doc_header"><code>make_dataset_archive_folder</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L90" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_dataset_archive_folder</code>(<strong><code>path</code></strong>:<code>str</code>, <strong><code>name</code></strong>:<code>str</code>, <strong><code>versions</code></strong>:<code>List</code>[<code>str</code>]=<em><code>None</code></em>, <strong><code>version</code></strong>:<code>str</code>=<em><code>'patch'</code></em>)</p>
</blockquote>
<p>Create a new dataset archive folder in <code>path</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_config</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">storage_client</span><span class="o">=</span><span class="s1">&#39;storage_tools.core.LocalStorageClient&#39;</span><span class="p">,</span>
                 <span class="n">local_path</span><span class="o">=</span><span class="s1">&#39;test/local_path2&#39;</span><span class="p">,</span><span class="n">storage_area</span><span class="o">=</span><span class="s1">&#39;test/storage_area2&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">_make_local_test_data</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">],</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;storage_area&#39;</span><span class="p">]]:</span> <span class="n">_rmtree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">test_files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a/b/test_data.2.0.0.txt&#39;</span><span class="p">,</span><span class="s1">&#39;test_data.txt&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span> <span class="n">test_files</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;sub/test_data.0.0.</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_files</span><span class="p">):</span>
        <span class="n">f</span><span class="o">=</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">f</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">_file</span><span class="p">:</span> <span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;a little bit of data </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_files</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_make_local_test_data</span><span class="p">()</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/test_data.txt.0.0.1&#39;</span><span class="p">,</span>
        <span class="n">make_dataset_archive_folder</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">],</span><span class="s1">&#39;test_data.txt&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/test_data.txt.2.5.0&#39;</span><span class="p">,</span>
        <span class="n">make_dataset_archive_folder</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">],</span><span class="s1">&#39;test_data.txt&#39;</span><span class="p">,[</span><span class="s1">&#39;2.4.6&#39;</span><span class="p">],</span><span class="s1">&#39;minor&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/sub.0.0.1&#39;</span><span class="p">,</span>
        <span class="n">make_dataset_archive_folder</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">],</span><span class="s1">&#39;sub&#39;</span><span class="p">))</span>
<span class="c1"># TODO: check archive folder contents</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="StorageClientABC" class="doc_header"><code>class</code> <code>StorageClientABC</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L113" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>StorageClientABC</code>(<strong><code>config</code></strong>:<code>dict</code>) :: <code>ABC</code></p>
</blockquote>
<p>Defines functionality common to all storage clients</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="StorageClientABC.__init__" class="doc_header"><code>StorageClientABC.__init__</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L116" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>StorageClientABC.__init__</code>(<strong><code>config</code></strong>:<code>dict</code>)</p>
</blockquote>
<p>Create a new storage client using the specified <code>config</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="StorageClientABC.ls" class="doc_header"><code>StorageClientABC.ls</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L127" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>StorageClientABC.ls</code>(<strong><code>what</code></strong>:<code>str</code>=<em><code>'storage_area'</code></em>, <strong><code>name_starts_with</code></strong>:<code>str</code>=<em><code>None</code></em>)</p>
</blockquote>
<p>Return a list containing the names of files in either <code>storage_area</code> or <code>local_path</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="StorageClientABC.ls_versions" class="doc_header"><code>StorageClientABC.ls_versions</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L149" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>StorageClientABC.ls_versions</code>(<strong><code>name</code></strong>:<code>str</code>, <strong><code>what</code></strong>:<code>str</code>=<em><code>'storage_area'</code></em>)</p>
</blockquote>
<p>Return a list containing all versions of the specified archive <code>name</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="StorageClientABC.upload_dataset" class="doc_header"><code>StorageClientABC.upload_dataset</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L156" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>StorageClientABC.upload_dataset</code>(<strong><code>name</code></strong>:<code>str</code>, <strong><code>version</code></strong>:<code>str</code>=<em><code>'patch'</code></em>)</p>
</blockquote>
<p>Create a new dataset archive and upload it to <code>storage_area</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li><code>name</code><ul>
<li>file or folder name</li>
<li>which must exist in "local_path"</li>
<li>without "local_path" prefix</li>
<li>e.g. if<ul>
<li>"local_path" is "~/storage_tools/test/local_path"</li>
<li>and you want to upload "~/storage_tools/test/local_path/test_data.txt" as a dataset</li>
<li>you would pass the name "test_data.txt"</li>
</ul>
</li>
</ul>
</li>
<li><code>version</code><ul>
<li>"major", "minor" or "patch" to automatically create a new version or</li>
<li>version literal that matches <code>\d+\.\d+\.\d+</code> (e.g. "1.0.45")</li>
</ul>
</li>
</ul>
<p><code>upload_dataset</code> will;</p>
<ul>
<li>create a folder <code>[local_path]/[name].[version]</code><ul>
<li>if this folder already exists, as error will be raised</li>
</ul>
</li>
<li>copy the file or folder contents (and all sub-folders) to this folder</li>
<li>create a manifest in this folder</li>
<li>create a zip archive, called <code>[name].[version].zip</code>, of this folder<ul>
<li>Use the optional <code>compression_level</code> config setting to control the level of compression used by <code>zlib</code></li>
<li>If you are creating a dataset of files that are already compressed (e.g. images, models etc), setting <code>compression_level=0</code> can make this step run much faster</li>
</ul>
</li>
<li>upload the zip archive to remote storage</li>
<li>return the location of the dataset in remote storage</li>
</ul>
<p>Why no <code>overwrite</code> option?</p>
<ul>
<li>It is not expected that archives will need to be overwritten<ul>
<li>as we want to be able to re-run old experiments using the data as it was</li>
</ul>
</li>
<li>bad archives could be deleted via storage API (e.g. <code>storage_client.client.delete_blob('test.0.0.1.zip')</code>) or via storage browsers<ul>
<li>we might want to add a soft delete, archive status etc to handle this kind of thing?</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="StorageClientABC.download_dataset" class="doc_header"><code>StorageClientABC.download_dataset</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L169" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>StorageClientABC.download_dataset</code>(<strong><code>name</code></strong>:<code>str</code>, <strong><code>version</code></strong>:<code>str</code>=<em><code>'latest'</code></em>, <strong><code>overwrite</code></strong>:<code>bool</code>=<em><code>False</code></em>)</p>
</blockquote>
<p>Download a dataset archive from <code>storage_area</code> and extract it to <code>local_path</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li><code>name</code><ul>
<li>dataset name</li>
</ul>
</li>
<li><code>version</code><ul>
<li>"latest" download the latest version of the dataset</li>
<li>version literal that matches <code>\d+\.\d+\.\d+</code> (e.g. "1.0.45")</li>
</ul>
</li>
<li><code>overwrite</code><ul>
<li>If <code>False</code> and the dataset exists in "local_path", this is a no op</li>
<li>If <code>True</code> and the dataset exists in "local_path", delete the dataset and re-download</li>
</ul>
</li>
</ul>
<p><code>download_dataset</code> will;</p>
<ul>
<li>download a zip archive, called <code>[name].[version].zip</code>, from remote storage</li>
<li>extract it to <code>[local_path]/[name].[version]</code></li>
<li>check that all files listed in manifest.json have the correct secure hash</li>
<li>return the location of the dataset in local storage</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="LocalStorageClient" class="doc_header"><code>class</code> <code>LocalStorageClient</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L186" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>LocalStorageClient</code>(<strong><code>config</code></strong>:<code>dict</code>) :: <a href="/storage_tools/core.html#StorageClientABC"><code>StorageClientABC</code></a></p>
</blockquote>
<p>Storage client that uses the local filesystem for both <code>storage_area</code> and <code>local_path</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/storage_tools/core.html#LocalStorageClient"><code>LocalStorageClient</code></a> will most often be used for local testing.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">storage_client</span><span class="o">=</span><span class="n">LocalStorageClient</span><span class="p">(</span><span class="n">test_config</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;storage_client&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;storage_tools.core.LocalStorageClient&#39;</span>
<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;bad_key&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="StorageClientABC.config_get" class="doc_header"><code>StorageClientABC.config_get</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L120" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>StorageClientABC.config_get</code>(<strong><code>key</code></strong>, <strong><code>default</code></strong>=<em><code>None</code></em>, <strong><code>dtype</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Return a value via <code>self.config.get</code> optionally checking that the value is of <code>dtype</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">config_get</span><span class="p">(</span><span class="s1">&#39;storage_client&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;storage_tools.core.LocalStorageClient&#39;</span>
<span class="k">assert</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">config_get</span><span class="p">(</span><span class="s1">&#39;bad_key&#39;</span><span class="p">)</span><span class="o">==</span><span class="kc">None</span>
<span class="k">assert</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">config_get</span><span class="p">(</span><span class="s1">&#39;storage_client&#39;</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;storage_tools.core.LocalStorageClient&#39;</span>
<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">config_get</span><span class="p">(</span><span class="s1">&#39;storage_client&#39;</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">config_get</span><span class="p">(</span><span class="s1">&#39;bad_key&#39;</span><span class="p">,</span><span class="s1">&#39;but its ok&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;but its ok&#39;</span>
<span class="k">assert</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">config_get</span><span class="p">(</span><span class="s1">&#39;storage_client&#39;</span><span class="p">,</span><span class="s1">&#39;default is not used&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;storage_tools.core.LocalStorageClient&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AzureStorageClient" class="doc_header"><code>class</code> <code>AzureStorageClient</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L207" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AzureStorageClient</code>(<strong><code>config</code></strong>:<code>dict</code>) :: <a href="/storage_tools/core.html#StorageClientABC"><code>StorageClientABC</code></a></p>
</blockquote>
<p>Storage client that uses Azure for <code>storage_area</code> and the local filesystem <code>local_path</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AwsStorageClient" class="doc_header"><code>class</code> <code>AwsStorageClient</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L241" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AwsStorageClient</code>(<strong><code>config</code></strong>:<code>dict</code>) :: <a href="/storage_tools/core.html#StorageClientABC"><code>StorageClientABC</code></a></p>
</blockquote>
<p>Storage client that uses AWS for <code>storage_area</code> and the local filesystem <code>local_path</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ideally, we would use the same property keys in settings.ini as the boto3 API but <code>ConfigParser</code> converts keys to lower case by default.</p>
<p>So if boto3 has a parameter called <code>Bucket</code>, we need <code>bucket=a-bucket-name</code> settings.ini.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="new_storage_client" class="doc_header"><code>new_storage_client</code><a href="https://github.com/pete88b/storage_tools/tree/main/storage_tools/core.py#L282" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>new_storage_client</code>(<strong><code>storage_name</code></strong>:<code>str</code>, <strong><code>config_name</code></strong>:<code>str</code>=<em><code>'secrets/settings.ini'</code></em>)</p>
</blockquote>
<p>Returns a storage client based on the configured <code>storage_client</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This function reads the <code>storage_name</code> section of <code>config_name</code>.</p>
<p>A key config setting is <code>storage_client</code> which should;</p>
<ul>
<li>specify the storage client implementation to use (fully qualified with package name)</li>
<li>refer to a module that can be imported</li>
<li>refer to a class that is a <a href="/storage_tools/core.html#StorageClientABC"><code>StorageClientABC</code></a> (that has not changed the signature of <code>__init__</code>)</li>
</ul>
<p>This makes it possible to use a storage client implementation that is not defined in this project.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">storage_client</span><span class="o">=</span><span class="n">new_storage_client</span><span class="p">(</span><span class="s1">&#39;local_test&#39;</span><span class="p">,</span><span class="s1">&#39;test/settings.ini&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;storage_client&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;storage_tools.core.LocalStorageClient&#39;</span>
<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">new_storage_client</span><span class="p">(</span><span class="s1">&#39;gcp_dummy&#39;</span><span class="p">,</span><span class="s1">&#39;test/settings.ini&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">],</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;storage_area&#39;</span><span class="p">]]:</span> <span class="n">_rmtree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="n">storage_client</span><span class="o">=</span><span class="n">LocalStorageClient</span><span class="p">(</span><span class="n">test_config</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">storage_client</span><span class="p">,</span><span class="n">LocalStorageClient</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;storage_client&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;storage_tools.core.LocalStorageClient&#39;</span>
<span class="n">test_eq</span><span class="p">([],</span><span class="n">storage_client</span><span class="o">.</span><span class="n">ls</span><span class="p">())</span>
<span class="n">test_eq</span><span class="p">([],</span><span class="n">storage_client</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s1">&#39;local_path&#39;</span><span class="p">))</span>
    
<span class="n">test_files</span><span class="o">=</span><span class="n">_make_local_test_data</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">([],</span><span class="n">storage_client</span><span class="o">.</span><span class="n">ls</span><span class="p">())</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">test_files</span><span class="p">,</span><span class="n">storage_client</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s1">&#39;local_path&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">([</span><span class="s1">&#39;a/b/test_data.2.0.0.txt&#39;</span><span class="p">],</span><span class="n">storage_client</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s1">&#39;local_path&#39;</span><span class="p">,</span><span class="s1">&#39;a/b&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">([],</span><span class="n">storage_client</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s1">&#39;local_path&#39;</span><span class="p">,</span><span class="s1">&#39;does/not/exist&#39;</span><span class="p">))</span>
        
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">test_files</span><span class="p">:</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">test_files</span><span class="p">,</span><span class="n">storage_client</span><span class="o">.</span><span class="n">ls</span><span class="p">())</span>
<span class="n">test_eq</span><span class="p">([</span><span class="s1">&#39;a/b/test_data.2.0.0.txt&#39;</span><span class="p">],</span><span class="n">storage_client</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">name_starts_with</span><span class="o">=</span><span class="s1">&#39;a/b&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">([],</span><span class="n">storage_client</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">name_starts_with</span><span class="o">=</span><span class="s1">&#39;does_no_exist&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">test_files</span><span class="p">,</span><span class="n">storage_client</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s1">&#39;local_path&#39;</span><span class="p">))</span>
<span class="n">_rmtree</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">([],</span><span class="n">storage_client</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s1">&#39;local_path&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">test_files</span><span class="p">:</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">test_files</span><span class="p">,</span><span class="n">storage_client</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s1">&#39;local_path&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="s1">&#39;a little bit of data 4&#39;</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/test_data.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/test_data.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">_file</span><span class="p">:</span> <span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;upd&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="s1">&#39;upd&#39;</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/test_data.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">storage_client</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;test_data.txt&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="s1">&#39;upd&#39;</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/test_data.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">storage_client</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;test_data.txt&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="s1">&#39;a little bit of data 4&#39;</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/test_data.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="s1">&#39;test_data.txt&#39;</span><span class="p">))</span>
<span class="n">storage_client</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="s1">&#39;test_data.txt&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">storage_client</span><span class="o">.</span><span class="n">ls_versions</span><span class="p">(</span><span class="s1">&#39;this/does/not/exitst&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">],</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;storage_area&#39;</span><span class="p">]]:</span> <span class="n">_rmtree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    
<span class="n">storage_client</span><span class="o">=</span><span class="n">LocalStorageClient</span><span class="p">(</span><span class="n">test_config</span><span class="p">)</span>
<span class="n">test_files</span><span class="o">=</span><span class="n">_make_local_test_data</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_t</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span><span class="n">upload_name</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="s1">&#39;patch&#39;</span><span class="p">):</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;storage_area&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">expected</span><span class="p">,</span><span class="n">storage_client</span><span class="o">.</span><span class="n">upload_dataset</span><span class="p">(</span><span class="n">upload_name</span><span class="p">,</span><span class="n">version</span><span class="p">))</span>
<span class="n">_t</span><span class="p">(</span><span class="s1">&#39;test_data.txt.0.0.1.zip&#39;</span><span class="p">,</span><span class="s1">&#39;test_data.txt&#39;</span><span class="p">)</span>
<span class="n">_t</span><span class="p">(</span><span class="s1">&#39;sub.0.0.1.zip&#39;</span><span class="p">,</span><span class="s1">&#39;sub&#39;</span><span class="p">)</span>
<span class="n">_t</span><span class="p">(</span><span class="s1">&#39;sub/test_data.0.0.2.txt.0.0.1.zip&#39;</span><span class="p">,</span><span class="s1">&#39;sub/test_data.0.0.2.txt&#39;</span><span class="p">)</span>
<span class="c1"># switch off compression when creating zip archives</span>
<span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;compression_level&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
<span class="n">_t</span><span class="p">(</span><span class="s1">&#39;a.3.0.0.zip&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;3.0.0&#39;</span><span class="p">)</span>
<span class="n">_t</span><span class="p">(</span><span class="s1">&#39;a.3.0.1.zip&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="c1"># TODO: check zip contents</span>
<span class="n">_rmtree</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/a.3.0.0&#39;</span><span class="p">)</span>
<span class="n">_rmtree</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/a.3.0.1&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">])</span><span class="o">/</span><span class="s1">&#39;a.3.0.1&#39;</span><span class="p">,</span><span class="n">storage_client</span><span class="o">.</span><span class="n">download_dataset</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">])</span><span class="o">/</span><span class="s1">&#39;a.3.0.0&#39;</span><span class="p">,</span><span class="n">storage_client</span><span class="o">.</span><span class="n">download_dataset</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;3.0.0&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">])</span><span class="o">/</span><span class="s1">&#39;a.3.0.0&#39;</span><span class="p">,</span><span class="n">storage_client</span><span class="o">.</span><span class="n">download_dataset</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;3.0.0&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">])</span><span class="o">/</span><span class="s1">&#39;a.3.0.0&#39;</span><span class="p">,</span><span class="n">storage_client</span><span class="o">.</span><span class="n">download_dataset</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;3.0.0&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">))</span>
<span class="c1"># check manifest was created and downloaded as part of the dataset</span>
<span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/a.3.0.0/manifest.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="n">check_archive</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/a.3.0.0&#39;</span><span class="p">)</span>
<span class="c1"># if we change the secure hash for any of the files in the dataset, check_archive should fail</span>
<span class="n">manifest</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/a.3.0.0/manifest.json&#39;</span><span class="p">))</span>
<span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sha256&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;thisllnevermatch&#39;</span>
<span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/a.3.0.0/manifest.json&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">))</span>
<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">check_archive</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/a.3.0.0&#39;</span><span class="p">))</span>
<span class="c1"># only files listed in the manifest are checked</span>
<span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
<span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/a.3.0.0/manifest.json&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">))</span>
<span class="n">check_archive</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/a.3.0.0&#39;</span><span class="p">)</span>
<span class="c1"># check_archive will fail if it can&#39;t find a manifest</span>
<span class="n">Path</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/a.3.0.0/manifest.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">check_archive</span><span class="p">(</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/a.3.0.0&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">storage_client</span><span class="o">=</span><span class="n">new_storage_client</span><span class="p">(</span><span class="s1">&#39;azure_dummy&#39;</span><span class="p">,</span><span class="s1">&#39;test/settings.ini&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">storage_client</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="s1">&#39;AzureStorageClient&#39;</span><span class="p">)</span>
<span class="n">storage_client</span><span class="o">=</span><span class="n">new_storage_client</span><span class="p">(</span><span class="s1">&#39;aws_dummy&#39;</span><span class="p">,</span><span class="s1">&#39;test/settings.ini&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">storage_client</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="s1">&#39;AwsStorageClient&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;local_path&#39;</span><span class="p">],</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;storage_area&#39;</span><span class="p">]]:</span> <span class="n">_rmtree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

